---
title: "Chapter 7 - Survival analysis"
format: 
  html:
    self-contained: true
    toc: true
    code-fold: true
---

### Section 7.5

Loading the Natality teaching dataset
```{r}
#| echo: false
#| message: false

library(here)
library(tidyverse)
library(survival)
library(sjPlot)
library(broom)

load(here('datasets', 'natality2018_rmph.Rdata'))
natality <- as.data.frame(natality)
```

```{r}
names(natality)
```
`preterm01` event
```{r}
count(natality, preterm01)
```
```{r}
surv.ex7.1 <- survfit(Surv(gestage37, preterm01) ~ 1, data=natality)
surv.ex7.1
```

```{r}
print(summary(surv.ex7.1), digits = 4)
```

## Section 7.6.2 - Computing and plotting hazard function

```{r}
haz.ex.7.1 <- bshazard::bshazard(Surv(gestage37, preterm01) ~ 1, 
                                 data=natality,
                                 verbose = FALSE,
                                 nk=15)
plot(haz.ex.7.1, conf.int = FALSE, xlab = 'Gestational age (days)',
     xlim = c(16, 37), lwd = 2, xaxt = "n")
axis(1, at = c(seq(17, 36, 3), 37))
```
What is the estimated probability that a woman will experience a preterm birth from 33 to 35 weeks inclusive?

$$P(33 \le T \le 35) = S(32) - S(35)$$
```{r}
S32 <- summary(surv.ex7.1, times=32)$surv
S35 <- summary(surv.ex7.1, times=35)$surv
c(S32, S35, S32 - S35)
```

## Section 7.6.3 - Comparing groups
```{r}
surv.ex7.4 <- survfit(Surv(gestage37, preterm01) ~ MRACEHISP, data = natality)
surv.ex7.4
```

Plotting survival curve
```{r}
plot(surv.ex7.4,
     xlab = "Gestational age (weeks)", ylab = "Survival probability",
     xlim = c(17, 37),
     ylim = c(0.75, 1),
     conf.int = FALSE, mark.time = FALSE,
     lty=1:4)
legend(20, 0.95, c("NH White", "NH Black", "NH Other", "Hispanic")[c(1,3,4,2)],
       lty=c(1,3,4,2), title = "Mother's Race/Ethinicity")
```
Log rank test
```{r}
survdiff.ex7.4 <- survdiff(Surv(gestage37, preterm01) ~ MRACEHISP, data = natality)
survdiff.ex7.4
```
```{r}
survdiff.ex7.4$n
```

## Section 7.8 - Fitting the Cox regression model
What is the effect of mother's race/ethnicity on the risk of experiencing preterm birth?
```{r}
cox.ex7.4 <- coxph(Surv(gestage37, preterm01) ~ MRACEHISP, data=natality)
summary(cox.ex7.4)
```
Compared to Whites, Black mothers are 2.3 times likely to experience preterm births.
Compared to Whites, Hispanic mothers are 1.5 times likely to experience preterm births.
There is no difference in terms of "Other" racial groups of experience preterm births compared to Whites.

```{r}
plot_model(cox.ex7.4, type="pred", terms = c("MRACEHISP"), show.values = TRUE)
```

```{r}
plot_model(cox.ex7.4, show.values = TRUE)
```
```{r}
summary(cox.ex7.4)$coefficients
```
```{r}
tidy(cox.ex7.4) |> 
  mutate(hr = exp(estimate), .after=term) |> 
  mutate(across(where(is.numeric), \(x) round(x, 4)))
```

```{r}
tidy(cox.ex7.4, exponentiate = TRUE, conf.int = TRUE) |> 
  select(-c(std.error, statistic)) |> 
  mutate(across(where(is.numeric), \(x) round(x, 3)))
```

```{r}
library(car)
Anova(cox.ex7.4, type = 3, test.statistic = "Wald")
```

## Section 7.8.2 Adjusted
